<div class="container my-5">
  <h1 class="text-center mb-5">Generador de Grupos para Torneos</h1>

  <!-- DATOS GENERALES -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white" (click)="isGeneralDataCollapsed = !isGeneralDataCollapsed" style="cursor: pointer;">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h4 mb-0">Datos Generales</h2>
        <i class="bi" [class.bi-chevron-down]="!isGeneralDataCollapsed" [class.bi-chevron-up]="isGeneralDataCollapsed"></i>
      </div>
    </div>
    <div class="card-body" [class.d-none]="isGeneralDataCollapsed">
      <!-- Nombre del torneo -->
      <div class="mb-3">
        <label for="tournamentName" class="form-label">Nombre del Torneo</label>
        <input 
          type="text" 
          class="form-control" 
          id="tournamentName" 
          [(ngModel)]="tournamentName"
          placeholder="Ingrese el nombre del torneo">
      </div>

      <!-- Número de categorías -->
      <div class="mb-3">
        <label for="numberOfCategories" class="form-label">Número de Categorías</label>
        <select 
          class="form-select" 
          id="numberOfCategories" 
          [(ngModel)]="numberOfCategories"
          (change)="onNumberOfCategoriesChange()">
          <option [value]="1">1</option>
          <option [value]="2">2</option>
          <option [value]="3">3</option>
          <option [value]="4">4</option>
          <option [value]="5">5</option>
        </select>
      </div>

      <!-- Nombres de las categorías -->
      <div class="mb-3" *ngFor="let category of categories">
        <label [for]="'category' + category.id" class="form-label">
          Nombre de la Categoría {{ category.id }}
        </label>
        <input 
          type="text" 
          class="form-control" 
          [id]="'category' + category.id" 
          [(ngModel)]="category.name"
          placeholder="Nombre de la categoría">
      </div>

      <!-- Grupos mezclados -->
      <div class="form-check">
        <input 
          class="form-check-input" 
          type="checkbox" 
          id="mixedGroups" 
          [(ngModel)]="mixedGroups"
          disabled>
        <label class="form-check-label text-muted" for="mixedGroups">
          Grupos mezclados entre categorías (Próximamente)
        </label>
        <div class="form-text">
          Esta funcionalidad estará disponible en una próxima actualización
        </div>
      </div>
    </div>
  </div>

  <!-- DATOS DE GRUPOS -->
  <div class="card mb-4">
    <div class="card-header bg-success text-white" (click)="isGroupDataCollapsed = !isGroupDataCollapsed" style="cursor: pointer;">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h4 mb-0">Datos de Grupos</h2>
        <i class="bi" [class.bi-chevron-down]="!isGroupDataCollapsed" [class.bi-chevron-up]="isGroupDataCollapsed"></i>
      </div>
    </div>
    <div class="card-body" [class.d-none]="isGroupDataCollapsed">
      <!-- Número de grupos -->
      <div class="mb-3">
        <label for="numberOfGroups" class="form-label">Número de Grupos</label>
        <input 
          type="number" 
          class="form-control" 
          id="numberOfGroups" 
          [(ngModel)]="numberOfGroups"
          (change)="onNumberOfGroupsChange()"
          min="1" 
          step="1">
      </div>

      <!-- Tipo de distribución -->
      <div class="mb-3">
        <label for="distributionType" class="form-label">Tipo de Distribución</label>
        <select 
          class="form-select" 
          id="distributionType" 
          [(ngModel)]="distributionType"
          (change)="onDistributionTypeChange()">
          <option [value]="GroupDistributionType.SAME_NUMBER">
            Mismo número de participantes para cada grupo
          </option>
          <option [value]="GroupDistributionType.AUTOMATIC">
            Número de participantes automático
          </option>
        </select>
      </div>

      <!-- Mínimo de participantes (solo para automático) -->
      <div class="mb-3" *ngIf="distributionType === GroupDistributionType.AUTOMATIC">
        <label for="minParticipants" class="form-label">Mínimo de Participantes por Grupo</label>
        <input 
          type="number" 
          class="form-control" 
          id="minParticipants" 
          [(ngModel)]="minParticipantsPerGroup"
          min="1" 
          step="1">
        <div class="form-text">
          Los participantes restantes se distribuirán de uno en uno en los grupos
        </div>
      </div>
    </div>
  </div>

  <!-- DATOS DE PARTICIPANTES -->
  <div class="card mb-4">
    <div class="card-header bg-info text-white" (click)="isParticipantDataCollapsed = !isParticipantDataCollapsed" style="cursor: pointer;">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h4 mb-0">Datos de Participantes</h2>
        <i class="bi" [class.bi-chevron-down]="!isParticipantDataCollapsed" [class.bi-chevron-up]="isParticipantDataCollapsed"></i>
      </div>
    </div>
    <div class="card-body" [class.d-none]="isParticipantDataCollapsed">
      <!-- Añadir participante individual -->
      <div class="row g-2 mb-4">
        <div class="col-md-5">
          <label for="participantName" class="form-label">Nombre del Participante</label>
          <input 
            type="text" 
            class="form-control" 
            id="participantName" 
            [(ngModel)]="newParticipantName"
            (keyup.enter)="addParticipant()"
            placeholder="Nombre del participante">
        </div>
        <div class="col-md-4">
          <label for="participantCategory" class="form-label">Categoría</label>
          <select 
            class="form-select" 
            id="participantCategory" 
            [(ngModel)]="selectedCategoryId">
            <option *ngFor="let category of categories" [value]="category.id">
              {{ category.name }}
            </option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button 
            type="button" 
            class="btn btn-primary w-100" 
            (click)="addParticipant()"
            [disabled]="!newParticipantName.trim()">
            Añadir
          </button>
        </div>
      </div>

      <!-- Añadir participantes masivamente -->
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <label for="bulkParticipants" class="form-label mb-0">Añadir Participantes Masivamente</label>
          <button 
            type="button" 
            class="btn btn-link btn-sm text-decoration-none" 
            (click)="toggleBulkInput()">
            {{ showBulkInput ? 'Ocultar' : 'Mostrar' }}
          </button>
        </div>
        <div *ngIf="showBulkInput">
          <div class="row g-2">
            <div class="col-md-10">
              <textarea 
                class="form-control" 
                id="bulkParticipants" 
                [(ngModel)]="bulkParticipantNames"
                rows="4"
                placeholder="Ingrese nombres separados por comas. Ejemplo: Juan Pérez (1), María García (2P), Carlos López (3)">
              </textarea>
              <div class="form-text">
                Separe los nombres con comas (,) o saltos de línea. Añada entre paréntesis: (1) a (5) para la categoría, P para pagado. Ejemplos: Juan (2), Ana (3P), Pedro (P). Sin paréntesis = Categoría 1, no pagado.
              </div>
            </div>
            <div class="col-md-2">
              <button 
                type="button" 
                class="btn btn-success w-100" 
                (click)="addBulkParticipants()"
                [disabled]="!bulkParticipantNames.trim()">
                Añadir Todos
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de participantes -->
      <div *ngIf="participants.length > 0">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Lista de Participantes ({{ participants.length }})</h5>
          <button 
            type="button" 
            class="btn btn-danger btn-sm" 
            (click)="deleteAllParticipants()"
            title="Borrar todos los participantes">
            <i class="bi bi-trash"></i> Borrar Todos
          </button>
        </div>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Nombre</th>
                <th>Categoría</th>
                <th>Pagado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let participant of participants">
                <td>
                  <span *ngIf="editingParticipantId !== participant.id">
                    {{ participant.name }}
                  </span>
                  <input 
                    *ngIf="editingParticipantId === participant.id"
                    type="text" 
                    class="form-control form-control-sm" 
                    [(ngModel)]="editingParticipantName"
                    (keyup.enter)="saveEditParticipant(participant)"
                    (keyup.escape)="cancelEdit()">
                </td>
                <td>
                  <span class="badge bg-secondary" *ngIf="editingParticipantId !== participant.id">
                    {{ getCategoryName(participant.categoryId) }}
                  </span>
                  <select 
                    *ngIf="editingParticipantId === participant.id"
                    class="form-select form-select-sm" 
                    [(ngModel)]="editingParticipantCategoryId">
                    <option *ngFor="let category of categories" [value]="category.id">
                      {{ category.name }}
                    </option>
                  </select>
                </td>
                <td>
                  <div class="form-check">
                    <input 
                      class="form-check-input" 
                      type="checkbox" 
                      [id]="'paid' + participant.id" 
                      [checked]="participant.isPaid"
                      (change)="togglePaid(participant)">
                    <label class="form-check-label" [for]="'paid' + participant.id">
                      {{ participant.isPaid ? 'Sí' : 'No' }}
                    </label>
                  </div>
                </td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    <button 
                      *ngIf="editingParticipantId !== participant.id"
                      type="button" 
                      class="btn btn-outline-primary" 
                      (click)="startEditParticipant(participant)"
                      title="Editar">
                      <i class="bi bi-pencil"></i> Editar
                    </button>
                    <button 
                      *ngIf="editingParticipantId === participant.id"
                      type="button" 
                      class="btn btn-outline-success" 
                      (click)="saveEditParticipant(participant)"
                      title="Guardar">
                      <i class="bi bi-check"></i> Guardar
                    </button>
                    <button 
                      *ngIf="editingParticipantId === participant.id"
                      type="button" 
                      class="btn btn-outline-secondary" 
                      (click)="cancelEdit()"
                      title="Cancelar">
                      <i class="bi bi-x"></i> Cancelar
                    </button>
                    <button 
                      type="button" 
                      class="btn btn-outline-danger" 
                      (click)="deleteParticipant(participant.id)"
                      title="Eliminar">
                      <i class="bi bi-trash"></i> Eliminar
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Mensaje cuando no hay participantes -->
      <div *ngIf="participants.length === 0" class="alert alert-info">
        No hay participantes añadidos. Comience añadiendo participantes usando el formulario de arriba.
      </div>
    </div>
  </div>

  <!-- GENERAR GRUPOS -->
  <div class="card mb-4" *ngIf="participants.length > 0">
    <div class="card-header bg-warning text-dark">
      <h2 class="h4 mb-0">Generar Grupos</h2>
    </div>
    <div class="card-body">
      <div class="d-grid gap-2">
        <button 
          type="button" 
          class="btn btn-warning btn-lg" 
          (click)="generateGroups()"
          [disabled]="!canGenerateGroups()">
          <i class="bi bi-shuffle"></i> Generar Grupos Aleatoriamente
        </button>
      </div>
    </div>
  </div>

  <!-- GRUPOS GENERADOS -->
  <div class="card mb-4" *ngIf="showGroups && generatedGroups.length > 0">
    <div class="card-header bg-success text-white">
      <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center" (click)="isGeneratedGroupsCollapsed = !isGeneratedGroupsCollapsed" style="cursor: pointer; flex-grow: 1;">
          <h2 class="h4 mb-0 me-2">Grupos Generados</h2>
          <i class="bi" [class.bi-chevron-down]="!isGeneratedGroupsCollapsed" [class.bi-chevron-up]="isGeneratedGroupsCollapsed"></i>
        </div>
        <div class="btn-group btn-group-sm" role="group" (click)="$event.stopPropagation()">
          <button 
            type="button" 
            class="btn btn-info" 
            (click)="assignRandomLetters()"
            title="Asignar letras aleatorias a los grupos">
            <i class="bi bi-shuffle"></i> Letras Aleatorias
          </button>
          <button 
            type="button" 
            class="btn btn-light" 
            (click)="exportToPDF()"
            title="Descargar PDF Resumen">
            <i class="bi bi-file-pdf"></i> PDF Resumen
          </button>
          <button 
            type="button" 
            class="btn btn-warning" 
            (click)="exportDetailedPDF()"
            title="Descargar PDF Detallado con Enfrentamientos">
            <i class="bi bi-file-earmark-text"></i> PDF Detallado
          </button>
        </div>
      </div>
    </div>
    <div class="card-body" [class.d-none]="isGeneratedGroupsCollapsed">
      <div class="row">
        <div class="col-md-6 col-lg-4 mb-3" *ngFor="let group of generatedGroups">
          <div class="card h-100 border-success">
            <div class="card-header bg-success bg-opacity-10 text-center">
              <h5 class="mb-0">{{ group.name }}</h5>
            </div>
            <div class="card-body">
              <ul class="list-group list-group-flush">
                <li class="list-group-item px-0" *ngFor="let participant of group.participants; let i = index">
                  <div class="d-flex justify-content-between align-items-center">
                    <span>{{ i + 1 }}. {{ participant.name }}</span>
                    <span class="badge bg-secondary">
                      {{ getCategoryName(participant.categoryId) }}
                    </span>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- GESTIÓN DE PARTIDOS Y CLASIFICACIÓN -->
  <div class="card mb-4" *ngIf="showGroups && generatedGroups.length > 0">
    <div class="card-header bg-warning text-dark" (click)="isMatchManagementCollapsed = !isMatchManagementCollapsed" style="cursor: pointer;">
      <div class="d-flex justify-content-between align-items-center">
        <h2 class="h4 mb-0">Gestión de Partidos y Clasificación</h2>
        <i class="bi" [class.bi-chevron-down]="!isMatchManagementCollapsed" [class.bi-chevron-up]="isMatchManagementCollapsed"></i>
      </div>
    </div>
    <div class="card-body" [class.d-none]="isMatchManagementCollapsed">
      <div *ngFor="let group of generatedGroups" class="mb-5">
        <h4 class="border-bottom pb-2 mb-3">{{ group.name }}</h4>
        
        <!-- Tabla de clasificación -->
        <div class="mb-4">
          <h5 class="mb-3">Clasificación</h5>
          <div class="table-responsive">
            <table class="table table-sm table-bordered">
              <thead class="table-light">
                <tr>
                  <th>Pos</th>
                  <th>Participante</th>
                  <th class="text-center">Victorias</th>
                  <th class="text-center">Dif. Goles</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let standing of getGroupStandings(group.id); let i = index">
                  <td class="text-center">{{ i + 1 }}</td>
                  <td>{{ getParticipantById(standing.participantId)?.name }}</td>
                  <td class="text-center">
                    {{ standing.wins }}
                  </td>
                  <td class="text-center">
                    <span [class.text-success]="standing.goalDifference > 0"
                          [class.text-danger]="standing.goalDifference < 0">
                      {{ standing.goalDifference }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Enfrentamientos -->
        <div>
          <h5 class="mb-3">Enfrentamientos</h5>
          <div class="list-group">
            <div class="list-group-item" *ngFor="let match of getGroupMatches(group.id)">
              <div class="row align-items-center">
                <div class="col-md-4 d-flex justify-content-between align-items-center">
                  <strong>{{ getParticipantById(match.participant1Id)?.name }}</strong>
                  <div class="form-check ms-3">
                    <input 
                      class="form-check-input" 
                      type="checkbox" 
                      [id]="'winner1-' + group.id + '-' + match.id"
                      [checked]="match.winner === 1"
                      (change)="onMatchWinnerChange(group.id, match, 1)">
                    <label class="form-check-label small" [for]="'winner1-' + group.id + '-' + match.id">
                      V
                    </label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="row g-2 align-items-center justify-content-center">
                    <div class="col-4">
                      <input 
                        type="number" 
                        class="form-control form-control-sm text-center" 
                        [(ngModel)]="match.score1"
                        (ngModelChange)="onMatchScoreChange(group.id, match)"
                        min="0"
                        placeholder="-">
                    </div>
                    <div class="col-2 text-center">
                      <span class="fw-bold">-</span>
                    </div>
                    <div class="col-4">
                      <input 
                        type="number" 
                        class="form-control form-control-sm text-center" 
                        [(ngModel)]="match.score2"
                        (ngModelChange)="onMatchScoreChange(group.id, match)"
                        min="0"
                        placeholder="-">
                    </div>
                  </div>
                </div>
                <div class="col-md-4 d-flex justify-content-between align-items-center">
                  <div class="form-check me-3">
                    <input 
                      class="form-check-input" 
                      type="checkbox" 
                      [id]="'winner2-' + group.id + '-' + match.id"
                      [checked]="match.winner === 2"
                      (change)="onMatchWinnerChange(group.id, match, 2)">
                    <label class="form-check-label small" [for]="'winner2-' + group.id + '-' + match.id">
                      V
                    </label>
                  </div>
                  <strong>{{ getParticipantById(match.participant2Id)?.name }}</strong>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
